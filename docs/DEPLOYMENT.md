# Deployment Guide

## Table of Contents
- [Deployment Architecture](#deployment-architecture)
- [Environment Configuration](#environment-configuration)
- [Build Process](#build-process)
- [Deployment Workflow](#deployment-workflow)
- [Edge Function Deployment](#edge-function-deployment)
- [Database Migrations](#database-migrations)
- [Rollback Procedures](#rollback-procedures)
- [Monitoring & Health Checks](#monitoring--health-checks)
- [Production Checklist](#production-checklist)

---

## Deployment Architecture

### Lovable Cloud Platform

Inner Odyssey is deployed on **Lovable Cloud**, which provides:

- **Automatic Frontend Deployment:** React app builds and deploys on code changes
- **Integrated Backend:** Supabase backend (PostgreSQL, Auth, Edge Functions) managed by Lovable
- **Edge Function Autoscaling:** Deno runtime scales automatically with traffic
- **CDN Distribution:** Frontend assets served via Cloudflare CDN
- **SSL/TLS:** Automatic HTTPS on all domains

**Infrastructure Stack:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Lovable Cloud Platform                  â”‚
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  React Frontend â”‚â—„â”€â”€â”€â”€â”€â”¤  Cloudflare CDN  â”‚    â”‚
â”‚  â”‚  (Vite Build)   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚           â”‚                                         â”‚
â”‚           â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚     Supabase Backend (Managed)          â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚      â”‚
â”‚  â”‚  â”‚PostgreSQLâ”‚  â”‚   Auth   â”‚  â”‚ Storageâ”‚â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚      â”‚
â”‚  â”‚  â”‚   Edge Functions (Deno Runtime)    â”‚ â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Project Details:**
- **Project ID:** `hcsglifjqdmiykrrmncn`
- **Region:** US East (auto-selected by Lovable)
- **Domain:** `[project-name].lovable.app` (custom domain supported)

---

## Environment Configuration

### Environment Variables

Environment variables are **auto-generated** by Lovable Cloud and stored in `.env`:

```bash
# Auto-generated by Lovable Cloud (DO NOT EDIT MANUALLY)
VITE_SUPABASE_URL=https://hcsglifjqdmiykrrmncn.supabase.co
VITE_SUPABASE_PUBLISHABLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
VITE_SUPABASE_PROJECT_ID=hcsglifjqdmiykrrmncn
```

**Important:**
- âœ… `.env` is regenerated on every build
- âŒ **Never** commit `.env` to Git (in `.gitignore`)
- âŒ **Never** edit `.env` manually (changes will be overwritten)
- âœ… Backend secrets managed via Lovable Cloud UI

---

### Secrets Management

Sensitive keys (API keys, service role keys) are stored in **Lovable Cloud Secrets**:

**Current Secrets:**
```
GEMINI_API_KEY         â†’ Lesson generation (AI)
RECAPTCHA_SECRET_KEY   â†’ Bot protection
SUPABASE_SERVICE_ROLE_KEY â†’ Admin operations
OPENAI_API_KEY         â†’ (Optional) Future AI features
ANTHROPIC_API_KEY      â†’ (Optional) Future AI features
```

**Adding/Updating Secrets:**
1. Navigate to **Backend â†’ Settings â†’ Secrets**
2. Click **Add Secret** or **Edit** existing
3. Enter name (all caps, snake_case)
4. Paste secret value
5. Save â†’ Secrets available in edge functions as `Deno.env.get('SECRET_NAME')`

**Security Best Practices:**
- âœ… Rotate secrets quarterly (especially after team member departure)
- âœ… Use different keys for staging/production
- âœ… Never log secret values
- âŒ Never expose secrets in frontend code (use edge functions)

---

## Build Process

### Development Build

```bash
# Local development (hot reload)
npm run dev

# Build output:
# - Runs on http://localhost:5173
# - Vite dev server with HMR
# - Instant updates on file changes
```

---

### Production Build

```bash
# Production build
npm run build

# Build steps:
1. TypeScript compilation (type checking)
2. Vite bundling (tree-shaking, minification)
3. Asset optimization (images, fonts)
4. Source map generation
5. Output to /dist folder

# Build output:
dist/
â”œâ”€â”€ assets/
â”‚   â”œâ”€â”€ index-[hash].js      # Main bundle (~500KB gzipped)
â”‚   â”œâ”€â”€ vendor-[hash].js     # Dependencies (~300KB gzipped)
â”‚   â”œâ”€â”€ [page]-[hash].js     # Code-split pages (~50KB each)
â”‚   â””â”€â”€ *.css                # Compiled Tailwind CSS
â””â”€â”€ index.html               # Entry point
```

**Build Optimization:**
- **Code Splitting:** Each route lazy-loaded (~50KB chunks)
- **Tree Shaking:** Unused code removed
- **Minification:** JavaScript/CSS compressed
- **Image Optimization:** SVG/PNG compressed
- **Caching:** Hashed filenames for immutable caching

**Target Metrics:**
| Metric | Target | Current |
|--------|--------|---------|
| Initial Load | <3s | ~2.1s |
| First Contentful Paint | <1.5s | ~1.2s |
| Time to Interactive | <3.5s | ~2.8s |
| Total Bundle Size | <1MB | ~850KB |

---

### Build Validation

**Pre-Deployment Checks:**
```bash
# 1. TypeScript type checking
npm run type-check

# 2. Linting
npm run lint

# 3. Build test
npm run build

# 4. Preview production build locally
npm run preview
# Opens http://localhost:4173
```

**Automated Checks (CI/CD):**
- âœ… TypeScript compilation succeeds
- âœ… No ESLint errors (warnings allowed)
- âœ… Build completes in <5 minutes
- âœ… Output bundle size < 1MB

---

## Deployment Workflow

### Lovable Cloud Auto-Deployment

**Trigger:** Code changes pushed to connected Git repository (or changes in Lovable editor)

**Workflow:**
```
Code Change â†’ Auto Build â†’ Deploy Frontend â†’ Edge Functions Deployed â†’ Live
     â†“            â†“              â†“                    â†“               â†“
  Git Push    Vite Build    Upload to CDN      Deno Deploy      Production
  (or editor)  (~3 min)      (~1 min)          (~30s)          (instant)
```

**Deployment Stages:**

1. **Build Stage** (3-5 minutes)
   - Pull latest code from Git
   - Install dependencies (`npm install`)
   - Run production build (`npm run build`)
   - Generate `/dist` folder

2. **Frontend Deploy** (1-2 minutes)
   - Upload static assets to Cloudflare CDN
   - Invalidate old cache
   - Update routing rules
   - Health check on new version

3. **Edge Functions Deploy** (30 seconds)
   - Deploy changed functions to Deno runtime
   - Warm up function instances
   - Validate function signatures

4. **Go Live** (instant)
   - Switch DNS to new version
   - Gradual rollout (canary deployment)
   - Monitor error rates

**Total Deployment Time:** ~5 minutes

---

### Manual Deployment

**Via Lovable UI:**
1. Navigate to project in Lovable dashboard
2. Click **"Publish"** button (top-right)
3. Select deployment target:
   - **Staging:** `staging.lovable.app` subdomain
   - **Production:** Custom domain or `[project].lovable.app`
4. Confirm deployment
5. Monitor deployment logs

**Via Git:**
```bash
# Push to main branch (triggers auto-deploy)
git add .
git commit -m "feat: Add lesson analytics dashboard"
git push origin main

# Deployment triggered automatically
# View status in Lovable UI â†’ Deployments
```

---

### Deployment Environments

**Staging Environment:**
- **URL:** `inner-odyssey-staging.lovable.app`
- **Purpose:** QA testing, beta features
- **Data:** Separate database from production
- **Auth:** Staging user accounts
- **Deployment:** Automatic on `develop` branch push

**Production Environment:**
- **URL:** `app.innerodyssey.com` (custom domain)
- **Purpose:** Live user-facing application
- **Data:** Production PostgreSQL database
- **Auth:** Real user accounts (COPPA/FERPA compliant)
- **Deployment:** Manual approval required (via Lovable UI)

---

## Edge Function Deployment

### Automatic Deployment

Edge functions in `supabase/functions/` are **automatically deployed** with code changes.

**Deployment Process:**
```
supabase/functions/generate-custom-lesson/index.ts
       â†“ (code change detected)
Lovable Cloud Build System
       â†“ (compile TypeScript)
Deno Runtime (Supabase Edge Functions)
       â†“ (deploy to regions: US East, EU West)
Function Live (invoke via supabase.functions.invoke)
```

**Deployment Time:** ~30 seconds per function

---

### Manual Function Deployment (Rare)

**Use Case:** Force redeploy without code changes (e.g., secret rotation)

**Via Lovable UI:**
1. Backend â†’ Edge Functions
2. Select function (e.g., `generate-custom-lesson`)
3. Click **"Redeploy"**
4. Confirm

**Verification:**
```bash
# Test function after deployment
curl -X POST 'https://hcsglifjqdmiykrrmncn.supabase.co/functions/v1/health-check' \
  -H "Content-Type: application/json" \
  --data '{"test": true}'

# Expected response:
# {"status": "healthy", "timestamp": "2025-11-15T10:30:00Z"}
```

---

### Function Configuration

**supabase/config.toml:**
```toml
[functions.generate-custom-lesson]
verify_jwt = true  # Require authentication

[functions.health-check]
verify_jwt = false  # Public endpoint
```

**Important:**
- âœ… Most functions should require JWT (`verify_jwt = true`)
- âš ï¸ Only health checks, webhooks should be public
- ğŸ”’ Service role operations should validate admin role

---

## Database Migrations

### Migration Process

Database schema changes are applied via **Lovable Cloud Migration Tool**.

**Workflow:**
```
1. Write SQL migration (ALTER TABLE, CREATE INDEX, etc.)
2. Submit via Migration Tool (UI or chat)
3. Review generated SQL
4. Approve migration
5. Apply to database (irreversible)
6. TypeScript types auto-regenerated (src/integrations/supabase/types.ts)
```

**Example Migration:**
```sql
-- Add screen_time_limit to children table
ALTER TABLE children 
ADD COLUMN daily_screen_time_limit_minutes INTEGER DEFAULT 60;

-- Add index for performance
CREATE INDEX idx_children_screen_time 
ON children(parent_id, daily_screen_time_limit_minutes)
WHERE screen_time_enabled = true;

-- Update RLS policy
DROP POLICY IF EXISTS "Parents can update children" ON children;
CREATE POLICY "Parents can update children"
ON children FOR UPDATE
USING (parent_id = auth.uid())
WITH CHECK (parent_id = auth.uid());
```

**Migration Checklist:**
- âœ… Test migration on staging database first
- âœ… Add `IF EXISTS` / `IF NOT EXISTS` clauses
- âœ… Include rollback plan in comments
- âœ… Update RLS policies if table structure changes
- âœ… Verify TypeScript types regenerated correctly

---

### Zero-Downtime Migrations

**Principles:**
1. **Additive Changes First:** Add new columns, then deprecate old ones
2. **Backward Compatible:** Old code works with new schema
3. **Gradual Rollout:** Migrate data in batches

**Example: Renaming Column**
```sql
-- Step 1: Add new column (deploy immediately)
ALTER TABLE children ADD COLUMN grade_level_new INTEGER;

-- Step 2: Backfill data (background job)
UPDATE children SET grade_level_new = grade_level WHERE grade_level_new IS NULL;

-- Step 3: Deploy code using new column (gradual rollout)
-- (Application reads/writes to grade_level_new)

-- Step 4: Drop old column (after 100% rollout)
ALTER TABLE children DROP COLUMN grade_level;
ALTER TABLE children RENAME COLUMN grade_level_new TO grade_level;
```

---

### Migration Rollback

**If migration fails or causes issues:**

1. **Immediate Rollback (if possible):**
```sql
-- Example: Rollback column addition
ALTER TABLE children DROP COLUMN IF EXISTS new_column;
```

2. **Restore from Backup:**
   - Navigate to Backend â†’ Database â†’ Backups
   - Select backup before migration (automated daily backups)
   - Restore (downtime: ~5 minutes)

3. **Forward Fix (preferred):**
   - Write corrective migration
   - Apply immediately
   - Faster than full restore

---

## Rollback Procedures

### Frontend Rollback

**Via Lovable UI:**
1. Navigate to **Deployments** (left sidebar)
2. View deployment history
3. Click **"Rollback"** on previous successful deployment
4. Confirm rollback
5. Wait ~2 minutes for DNS propagation

**Via Git:**
```bash
# Revert to previous commit
git revert HEAD
git push origin main

# Or reset to specific commit
git reset --hard <commit-hash>
git push --force origin main  # âš ï¸ Use with caution
```

**Rollback Time:** ~2-5 minutes

---

### Edge Function Rollback

**Option 1: Redeploy Previous Version**
1. Checkout previous Git commit locally
2. Copy function code from old commit
3. Paste into current codebase
4. Push to trigger redeploy

**Option 2: Manual Code Revert**
1. Backend â†’ Edge Functions â†’ [Function Name]
2. View deployment history
3. Copy code from previous version
4. Paste in editor, save
5. Redeploy

---

### Database Rollback (CRITICAL)

**âš ï¸ Database rollbacks are HIGH RISK. Plan carefully.**

**Safe Rollback (Additive Changes):**
```sql
-- If you ADDED a column, simply drop it
ALTER TABLE children DROP COLUMN IF EXISTS new_column;

-- If you ADDED an index, simply drop it
DROP INDEX IF EXISTS idx_new_index;
```

**Dangerous Rollback (Data Loss Risk):**
```sql
-- If you DELETED a column, restore from backup
-- (Data lost unless backup exists)

-- If you MODIFIED data, restore from backup
-- (Original values lost)
```

**Restore from Backup:**
1. Backend â†’ Database â†’ Backups
2. Select backup timestamp (before migration)
3. Click **"Restore"**
4. Confirm (âš ï¸ **Overwrites current data**)
5. Wait ~10 minutes for restore

**Prevention:**
- âœ… Always test migrations on staging first
- âœ… Take manual backup before risky migrations
- âœ… Use transactions where possible (automatic rollback on error)

---

## Monitoring & Health Checks

### Application Health Check

**Endpoint:** `https://hcsglifjqdmiykrrmncn.supabase.co/functions/v1/health-check`

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2025-11-15T10:30:00Z",
  "services": {
    "database": "connected",
    "auth": "operational",
    "edge_functions": "running"
  },
  "version": "1.2.0"
}
```

**Automated Monitoring:**
- **Uptime Check:** Every 5 minutes
- **Alert Threshold:** 3 consecutive failures
- **Notification:** Email + Slack webhook

---

### Post-Deployment Validation

**Checklist (run within 30 minutes of deployment):**

1. **Frontend:**
   - âœ… Homepage loads (`/`)
   - âœ… Login/signup functional (`/login`, `/signup`)
   - âœ… Parent dashboard loads (`/parent-dashboard`)
   - âœ… Child dashboard loads (`/child/:childId/dashboard`)
   - âœ… No console errors (check browser DevTools)

2. **Backend:**
   - âœ… Health check endpoint returns 200
   - âœ… Edge functions invokable (test one function)
   - âœ… Database queries respond (test SELECT query)
   - âœ… Authentication works (test login flow)

3. **Performance:**
   - âœ… Lighthouse score >85 (mobile)
   - âœ… Page load time <3s (homepage)
   - âœ… API response time <500ms (p95)

4. **Error Rates:**
   - âœ… Frontend error rate <1% (last hour)
   - âœ… Edge function error rate <2% (last hour)
   - âœ… Database error rate <0.5% (last hour)

---

### Monitoring Dashboards

**Access:**
- **Application Metrics:** Backend â†’ Monitor
- **Edge Function Logs:** Backend â†’ Edge Functions â†’ [Function] â†’ Logs
- **Database Performance:** Backend â†’ Database â†’ Performance

**Key Metrics:**
| Metric | Alert Threshold |
|--------|----------------|
| Uptime | <99.5% (monthly) |
| Error Rate | >2% (hourly) |
| Response Time (p95) | >1s |
| Database Connections | >80% capacity |
| Edge Function Failures | >5% (10 min) |

---

## Production Checklist

### Pre-Launch Checklist

**Security:**
- [ ] RLS enabled on all tables with sensitive data
- [ ] All secrets rotated (not default values)
- [ ] HTTPS enforced on custom domain
- [ ] CORS headers correctly configured
- [ ] Rate limiting enabled (API endpoints)
- [ ] Emotion data encrypted (trigger, reflection_notes)

**Performance:**
- [ ] Lighthouse score >90 (mobile)
- [ ] Bundle size <1MB (gzipped)
- [ ] Images optimized (WebP format)
- [ ] Lazy loading implemented (routes + heavy components)
- [ ] Database indexes on frequently queried columns

**Compliance:**
- [ ] COPPA consent flow implemented
- [ ] Privacy policy accessible (`/privacy`)
- [ ] Terms of service accessible (`/terms`)
- [ ] Data export functionality (parent dashboard)
- [ ] Account deletion functionality (settings)

**Monitoring:**
- [ ] Health check endpoint deployed
- [ ] Error tracking enabled (console logs â†’ monitoring)
- [ ] Performance monitoring enabled (Core Web Vitals)
- [ ] Uptime monitoring configured (5-minute checks)
- [ ] Alert notifications configured (email + Slack)

**Documentation:**
- [ ] README.md updated with production URLs
- [ ] API documentation complete (edge functions)
- [ ] Runbook created (incident response procedures)
- [ ] Architecture diagram up-to-date

---

### Post-Launch Checklist

**Day 1:**
- [ ] Monitor error rates (hourly)
- [ ] Check uptime (every 2 hours)
- [ ] Review edge function logs (identify anomalies)
- [ ] Test critical user flows (signup, lesson completion)

**Week 1:**
- [ ] Analyze performance metrics (Lighthouse scores)
- [ ] Review user feedback (beta testing channel)
- [ ] Check database performance (slow queries)
- [ ] Verify billing/usage within budget

**Month 1:**
- [ ] Security audit (RLS policies, access logs)
- [ ] Performance optimization (based on real user data)
- [ ] Documentation updates (based on support tickets)
- [ ] Disaster recovery drill (test backups, rollback procedures)

---

### Deployment Approval Process

**Staging Deployment (Auto-Approved):**
- Any developer can deploy to staging
- No approval required
- Automatic on `develop` branch push

**Production Deployment (Manual Approval):**
1. Developer submits PR to `main` branch
2. Code review by senior developer
3. QA testing on staging environment
4. Product owner approval (if user-facing changes)
5. Merge to `main` â†’ Triggers production build
6. Manual "Go Live" button click in Lovable UI

**Emergency Hotfix (Expedited Approval):**
- Critical bug fix or security patch
- Approval by any senior developer
- Deploy directly to production
- Notify team immediately (Slack #deployments)

---

## Deployment FAQs

**Q: How long does a typical deployment take?**  
A: ~5 minutes (3 min build, 2 min deployment)

**Q: Can I deploy frontend and backend separately?**  
A: No, they deploy together. Edge functions deploy automatically with code changes.

**Q: What happens if deployment fails?**  
A: Lovable Cloud automatically rolls back to previous version. Check deployment logs for error details.

**Q: How do I deploy to a custom domain?**  
A: Navigate to Settings â†’ Domains â†’ Add Custom Domain. Follow DNS configuration instructions (CNAME record).

**Q: Can I schedule deployments?**  
A: Not natively supported. Use Git actions or manual deployment at scheduled time.

**Q: How do I test database migrations before production?**  
A: Apply migration to staging database first. Verify with test queries. Then apply to production.

**Q: What if I accidentally delete production data?**  
A: Restore from automatic daily backup (Backend â†’ Backups). Max data loss: 24 hours.

**Q: How do I monitor real user performance?**  
A: Use built-in performance monitoring (Backend â†’ Monitor). Or integrate third-party APM (e.g., Sentry).

---

**Last Updated:** 2025-11-15  
**Maintainer:** Inner Odyssey DevOps Team  
**Review Frequency:** Quarterly
