# Row Level Security (RLS) Implementation

## Overview

Row Level Security (RLS) is Postgres's built-in mechanism for securing data at the database level. This document describes the RLS policies implemented for Odyssey Learns to ensure:

1. **Default-Deny Posture**: No data is accessible unless explicitly allowed
2. **Cross-User Data Isolation**: Users cannot access other users' data
3. **Parent-Child Boundaries**: Parents only access their own children's data
4. **Role-Based Access**: Admins and reviewers have appropriate elevated permissions

## Security Principles

### 1. Default-Deny
All tables have RLS enabled (`ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;`). Without explicit policies granting access, **no rows are accessible** to any user.

### 2. Explicit Policies
Every access pattern (SELECT, INSERT, UPDATE, DELETE) requires an explicit policy. We do not rely on:
- Application-level checks alone
- Implicit trust of authenticated users
- Client-side validation

### 3. Parent-Child Isolation
The core security model:
```sql
-- Parents can only access data for children they own
USING (
  child_id IN (
    SELECT id FROM children WHERE parent_id = auth.uid()
  )
)
```

### 4. User Isolation
Users can only access their own data:
```sql
-- Users see only their own profiles
USING (auth.uid() = id)
```

## Table-by-Table Policy Summary

### Core User Tables

#### `profiles`
- **SELECT**: Users can view their own profile
- **UPDATE**: Users can update their own profile
- **INSERT**: Users can create their own profile (on signup)
- **Cross-user protection**: `auth.uid() = id`

#### `children`
- **SELECT**: Parents can view their own children
- **INSERT/UPDATE/DELETE**: Parents can manage their own children
- **Cross-user protection**: `auth.uid() = parent_id`

### Learning & Progress Tables

#### `lessons`
- **SELECT**: All authenticated users can view active lessons
- **Purpose**: Public curriculum, no sensitive data
- **Note**: Lesson content is not user-specific

#### `user_progress`
- **SELECT**: Parents can view their children's progress
- **INSERT/UPDATE**: Parents can record progress for their children
- **Cross-user protection**: Verified via `children` table ownership

#### `child_generated_lessons`
- **SELECT**: Parents can view lessons generated by their children
- **INSERT**: Parents can create lessons for their children
- **DELETE**: Parents can delete lessons for their children
- **Cross-user protection**: Verified via `children` table

### Gamification Tables

#### `achievement_badges`
- **SELECT**: All authenticated users (public badge definitions)
- **Purpose**: Badge metadata is not user-specific

#### `user_badges`
- **SELECT**: Parents can view badges earned by their children
- **INSERT**: Parents can award badges to their children
- **Cross-user protection**: Verified via `children` table

#### `rewards`
- **SELECT**: Parents can view their own rewards
- **INSERT/UPDATE/DELETE**: Parents manage their own rewards
- **Cross-user protection**: `auth.uid() = parent_id`

#### `reward_redemptions`
- **SELECT**: Parents can view redemptions for their children
- **INSERT**: Parents approve redemptions for their children
- **Cross-user protection**: Verified via `children` table

#### `daily_lesson_quota`
- **SELECT**: Parents can view quotas for their children
- **UPDATE**: Parents can modify quotas for their children
- **Cross-user protection**: Verified via `children` table

#### `lesson_tokens`
- **SELECT**: Parents can view tokens for their children
- **UPDATE**: System can update token counts
- **Cross-user protection**: Verified via `children` table

### Emotional Intelligence Tables

#### `emotion_logs`
- **SELECT**: Parents can view emotion logs for their children
- **INSERT**: Parents can create emotion logs for their children
- **Cross-user protection**: Verified via `children` table
- **Privacy**: Emotional data is highly sensitive

### Social & Collaboration Tables

#### `peer_connections`
- **SELECT**: Parents can view connections involving their children
- **Policy**: Matches on either `child_id` or `peer_child_id`
- **Cross-user protection**: Both sides verified via `children` table

#### `shared_activities`
- **SELECT**: Parents can view activities shared by their children
- **INSERT**: Parents can approve activity shares
- **Cross-user protection**: Verified via `children` table

#### `activity_participants`
- **SELECT**: Parents can view participants in activities their children join
- **Cross-user protection**: Verified via `children` table

#### `collaboration_requests`
- **SELECT**: Parents can view requests involving their children
- **UPDATE**: Parents can approve/deny requests
- **Cross-user protection**: Verified via `children` table on both ends

### Analytics Tables

#### `analytics_events`
- **SELECT**: Parents can view analytics for their children
- **INSERT**: System records analytics events
- **Cross-user protection**: Verified via `children` table
- **Purpose**: Behavioral analytics (page views, clicks, etc.)

#### `lesson_analytics_events`
- **SELECT**: Parents can view lesson analytics for their children
- **Cross-user protection**: Verified via `children` table
- **Purpose**: Lesson-specific analytics (time spent, completion, etc.)

#### `student_lesson_performance`
- **SELECT**: Parents can view performance metrics for their children
- **Cross-user protection**: Verified via `children` table

#### `daily_lesson_stats`
- **SELECT**: Parents can view daily stats for their children
- **Cross-user protection**: Verified via `children` table

### Parent Communication Tables

#### `parent_child_messages`
- **SELECT**: Parents can view messages with their children
- **INSERT**: Parents can send messages to their children
- **Cross-user protection**: Verified via `children` table

#### `parent_notifications`
- **SELECT**: Parents can view their own notifications
- **UPDATE**: Parents can mark notifications as read
- **Cross-user protection**: `auth.uid() = parent_id`

#### `parent_weekly_reports`
- **SELECT**: Parents can view their own reports
- **Cross-user protection**: `auth.uid() = parent_id`

### Screen Time Management

#### `screen_time_sessions`
- **SELECT**: Parents can view sessions for their children
- **INSERT/UPDATE**: System records screen time usage
- **Cross-user protection**: Verified via `children` table
- **Purpose**: Enforcement of screen time limits

### Content Review System (Role-Based)

#### `lesson_reviews`
- **SELECT**: Reviewers can view reviews they're assigned to
- **UPDATE**: Reviewers can update their assigned reviews
- **Admin access**: Admins can view/manage all reviews
- **Cross-user protection**: `reviewer_id = auth.uid()` OR admin role

#### `review_history`
- **SELECT**: Reviewers can view history for their reviews
- **Cross-user protection**: Via `lesson_reviews` join + role check

#### `reviewer_performance`
- **SELECT**: Reviewers can view their own performance
- **Admin access**: Admins can view all reviewer performance
- **Cross-user protection**: Reviewer ID match OR admin role

### Creator System

#### `creator_rewards`
- **SELECT**: Creators can view their own rewards
- **Cross-user protection**: `creator_id = auth.uid()`

#### `creator_reward_history`
- **SELECT**: Creators can view their own reward history
- **Cross-user protection**: Via `creator_rewards` join

### Security & Monitoring Tables (Admin-Only)

#### `security_alerts`
- **SELECT**: Admin role only
- **Purpose**: Security incident monitoring
- **Cross-user protection**: Role check via `user_roles`

#### `failed_auth_attempts`
- **SELECT**: Admin role only
- **Purpose**: Brute force detection
- **Cross-user protection**: Role check via `user_roles`

#### `data_access_audit`
- **SELECT**: Admin role only
- **Purpose**: Compliance auditing
- **Cross-user protection**: Role check via `user_roles`

#### `security_access_log`
- **SELECT**: Admin role only
- **Purpose**: Access pattern monitoring
- **Cross-user protection**: Role check via `user_roles`

#### `user_access_baselines`
- **SELECT**: Admin role only
- **Purpose**: Anomaly detection
- **Cross-user protection**: Role check via `user_roles`

#### `ip_blocklist`
- **SELECT**: Admin role only
- **Purpose**: IP-based blocking
- **Cross-user protection**: Role check via `user_roles`

#### `error_logs`
- **SELECT**: Users can view their own errors, admins view all
- **Purpose**: Error tracking and debugging
- **Cross-user protection**: `user_id = auth.uid()` OR admin role

### Rate Limiting Tables

#### `api_rate_limits`
- **SELECT**: Users can view their own rate limits
- **UPDATE**: System updates rate limit counters
- **Cross-user protection**: User identifier match

#### `rate_limit_violations`
- **SELECT**: Admin role only
- **Purpose**: Security monitoring
- **Cross-user protection**: Role check via `user_roles`

#### `collaboration_rate_limit`
- **SELECT**: Parents can view limits for their children
- **Cross-user protection**: Verified via `children` table

### Compliance & Consent Tables

#### `parental_consent_log`
- **SELECT**: Parents can view their own consent records
- **INSERT**: System records consent
- **Cross-user protection**: `parent_id = auth.uid()`
- **Purpose**: COPPA compliance

#### `data_export_log`
- **SELECT**: Users can view their own export requests
- **INSERT**: Users can request data exports
- **Cross-user protection**: `user_id = auth.uid()`
- **Purpose**: GDPR/CCPA compliance

### Lesson Content Tables

#### `lesson_notes`
- **SELECT**: Parents can view notes for their children
- **INSERT/UPDATE**: Parents can create/edit notes for their children
- **Cross-user protection**: Verified via `children` table

#### `lesson_quality_scores`
- **SELECT**: Public (aggregate quality metrics)
- **Purpose**: Lesson rating system

#### `lesson_performance_metrics`
- **SELECT**: Aggregate metrics, no personal data
- **Purpose**: System-level performance tracking

### Beta Program Tables

#### `beta_feedback`
- **SELECT**: Users can view their own feedback
- **INSERT**: Users can submit feedback
- **Admin access**: Admins can view all feedback
- **Cross-user protection**: `user_id = auth.uid()` OR admin role

### Utility Tables

#### `role_audit_log`
- **SELECT**: Admin role only
- **Purpose**: Track role changes for security
- **Cross-user protection**: Role check via `user_roles`

#### `user_roles`
- **SELECT**: Admin role only
- **Purpose**: Role management
- **Cross-user protection**: Admin-only access

#### `idempotency_cache`
- **SELECT**: System-level access
- **Purpose**: Prevent duplicate operations
- **Note**: No user data, short-lived cache

#### `lesson_generation_dedup`
- **SELECT**: System-level access
- **Purpose**: Prevent duplicate lesson generation
- **Note**: No user data

#### `avatar_items`
- **SELECT**: All authenticated users (public item catalog)
- **Purpose**: Avatar customization options

## Testing RLS Policies

### Manual Testing

You can test RLS policies by switching user contexts:

```sql
-- Set up test users
SET LOCAL ROLE authenticated;
SET LOCAL "request.jwt.claims" TO '{"sub": "user-id-here"}';

-- Try to access another user's data (should return 0 rows)
SELECT * FROM children WHERE parent_id != 'user-id-here';

-- Try to access own data (should work)
SELECT * FROM children WHERE parent_id = 'user-id-here';
```

### Automated Testing

Run RLS violation tests:

```bash
# From project root
npm run test:rls  # Future: automated RLS test suite
```

### Common Test Cases

1. **Parent A cannot view Parent B's children**
2. **Parent A cannot modify Parent B's children**
3. **Parent A cannot view Parent B's reward redemptions**
4. **Parent A cannot read emotion logs from Parent B's children**
5. **Non-admin cannot view security alerts**
6. **Reviewer A cannot modify Reviewer B's lesson reviews**

## RLS Performance Considerations

### Indexes for RLS Queries

RLS policies execute for every query. Ensure indexes exist for RLS conditions:

```sql
-- Children table
CREATE INDEX idx_children_parent_id ON children(parent_id);

-- User progress
CREATE INDEX idx_user_progress_child_id ON user_progress(child_id);

-- Analytics events
CREATE INDEX idx_analytics_events_child_id ON analytics_events(child_id);

-- Emotion logs
CREATE INDEX idx_emotion_logs_child_id ON emotion_logs(child_id);
```

### Query Plans

Check query plans to verify index usage:

```sql
EXPLAIN ANALYZE
SELECT * FROM user_progress WHERE child_id = 'some-child-id';
```

RLS policies should use indexes, not sequential scans.

## Bypassing RLS (Admin Operations)

For system-level operations (migrations, batch jobs):

```sql
-- Temporarily disable RLS (requires superuser or table owner)
ALTER TABLE table_name DISABLE ROW LEVEL SECURITY;

-- Perform operation
-- ...

-- Re-enable RLS
ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;
```

**Never** disable RLS in application code or for user-facing operations.

## RLS Debugging

### View Applied Policies

```sql
SELECT 
  schemaname, 
  tablename, 
  policyname, 
  permissive, 
  cmd,
  qual,
  with_check
FROM pg_policies 
WHERE schemaname = 'public' 
ORDER BY tablename, policyname;
```

### Check RLS Status

```sql
SELECT 
  tablename, 
  rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public';
```

### Common Issues

1. **No rows returned**: RLS is blocking access (check `auth.uid()`)
2. **Slow queries**: Missing indexes on RLS condition columns
3. **INSERT fails**: `WITH CHECK` policy is too restrictive
4. **UPDATE fails**: Both `USING` and `WITH CHECK` must pass

## Security Audit Checklist

- [ ] All tables have `ENABLE ROW LEVEL SECURITY`
- [ ] No tables use `FORCE ROW LEVEL SECURITY` unnecessarily
- [ ] All parent-child queries verify ownership via `children` table
- [ ] Admin operations check `user_roles` table
- [ ] No policies use `USING (true)` or overly permissive conditions
- [ ] Sensitive tables (security, audit) are admin-only
- [ ] Indexes exist for all RLS join conditions
- [ ] Policies tested with multiple user contexts
- [ ] Documentation matches implementation

## Compliance Notes

### COPPA (Children's Online Privacy Protection Act)
- Parents have exclusive access to their children's data
- Parental consent logged in `parental_consent_log`
- Children cannot access platform without parent account

### FERPA (Family Educational Rights and Privacy Act)
- Educational records (progress, performance) are parent-accessible only
- No third-party access without explicit consent
- Audit logs track all data access

### GDPR/CCPA (Data Privacy Regulations)
- Data export capability (`data_export_log`)
- Right to deletion supported
- Audit trails for data access

## Maintenance

### Adding New Tables
1. Enable RLS: `ALTER TABLE table_name ENABLE ROW LEVEL SECURITY;`
2. Define policies for SELECT, INSERT, UPDATE, DELETE
3. Add tests for cross-user access violations
4. Update this documentation

### Modifying Policies
1. Create migration with `DROP POLICY` and `CREATE POLICY`
2. Test with multiple user contexts
3. Verify query performance (EXPLAIN ANALYZE)
4. Update documentation

## References

- [Postgres RLS Documentation](https://www.postgresql.org/docs/current/ddl-rowsecurity.html)
- [Supabase RLS Guide](https://supabase.com/docs/guides/auth/row-level-security)
- [OWASP Access Control](https://owasp.org/www-community/Access_Control)
